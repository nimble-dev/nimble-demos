---
title: "Bayesian_clinical_trial"
output: html_notebook
---

# Example of using NIMBLE for a Bayesian clinical trial analysis.

This example is taken from Chapter 6 of [Bayesian Adaptive Methods for Clinical Trials](https://www.crcpress.com/Bayesian-Adaptive-Methods-for-Clinical-Trials/Berry-Carlin-Lee-Muller/p/book/9781439825488) by Berry et al. (CRC Press, 2010).

The code and data were downloaded from [Bradley Carlin's web page](http://www.biostat.umn.edu/~brad/software/BCLM_ch6.html) on August 10, 2017.

## Make a NIMBLE model from the BUGS code

We could use NIMBLE's `readBUGSmodel` to load the model and data from the WinBUGS-format file `NN_BUGSdelta.txt`.  But instead I'll copy the pieces here to show how they can be created directly in R.

```{r}
library(nimble)

NNd_code <- nimbleCode({
  for( i in 1:n) {
    meen0[i] <- theta0 + beta0*x0[i]
    Y0[i] ~ dnorm(meen0[i] , prec0)
    meen1[i] <- theta1 + beta1*x1[i]
    Y1[i] ~ dnorm(meen1[i] , prec1)
    }

  theta0 ~ dnorm(mutheta, etatheta)
  theta1 ~ dnorm(mutheta, etatheta)
  beta0 ~ dnorm(mubeta, etabeta)
  beta1 ~ dnorm(mubeta, etabeta)
  delta <- beta1 - beta0
  withinc <- step(cee-delta)*step(cee+delta)

  mutheta ~ dflat()
  mubeta ~ dflat()
  etatheta ~ dgamma(atheta, btheta)
  etabeta ~ dgamma(abeta, bbeta)
  tausqtheta <- 1/etatheta
  tausqbeta <- 1/etabeta

  prec0 <- 1; prec1 <- 1
})

NNd_data <- list(x0 = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),	
     x1 = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1),
     Y0 = c( 0.38, -0.89, -0.19,  0.16,  1.24,  1.95, -0.07, -0.78,  0.24,  0.03, -0.57,
                -0.58,  0.01, -0.57, -0.54, -0.73,  0.27, -0.05,  0.60, -0.70),
     Y1 = c(10.13, 11.19, 10.15,  9.46,  9.47,  9.42, 10.39,  9.39,  9.86,  8.67, 10.89,
                10.45, 10.97,  9.06, 10.38, 10.10, 10.00,  9.64,  9.98, 10.46), 
     atheta = .1, btheta = .1, abeta = .1, bbeta = .1, n=20)

NNd_inits <- list(mutheta=0, mubeta=0, etatheta=1, etabeta=1)

## We can set data later, but it is convenient to do so here.
NNd_model <- nimbleModel(NNd_code, constants = NNd_data, inits = NNd_inits)

```

## Examples of using the model object

## Configure an MCMC

```{r}
NNd_mcmcConf <- configureMCMC(NNd_model)
NNd_mcmcConf$printSamplers()
```

The choices of samplers can be customized.

It is easy to write new samplers.

## Build the MCMC

```{r}
NNd_mcmc <- buildMCMC(NNd_mcmcConf)
```

## Compile the model and MCMC

```{r}
NNd_compiled <- compileNimble(NNd_model, NNd_mcmc)
```

## Running the MCMC

```{r}
NNd_compiled$NNd_mcmc$run(1000)
samples <- as.matrix(NNd_compiled$NNd_mcmc$mvSamples)
```

## Look at results

```{r}
library(MCMCvis)
library(coda)
MCMCtrace(as.mcmc.list(as.mcmc(samples)),
pdf = TRUE, filename = 'NNd_trace_plots.pdf')
```

We can inspect the [trace plots](NNd_trace_plots.pdf).
